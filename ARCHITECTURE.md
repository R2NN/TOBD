# 📐 Архитектура системы Enterprise Log Intelligence Platform

## 📋 Оглавление

1. [Общее описание](#общее-описание)
2. [Архитектурная схема](#архитектурная-схема)
3. [Компоненты системы](#компоненты-системы)
4. [ETL Pipeline](#etl-pipeline)
5. [Хранение данных](#хранение-данных)
6. [ML-анализ](#ml-анализ)
7. [Визуализация](#визуализация)
8. [Развёртывание](#развёртывание)

---

## 🎯 Общее описание

**Enterprise Log Intelligence Platform** — распределённая система обработки и анализа логов с применением технологий Big Data и машинного обучения.

### Ключевые технологии

| Категория | Технология | Назначение |
|-----------|------------|------------|
| **Orchestration** | Apache Airflow | Планирование и оркестрация ETL-задач |
| **Big Data** | Dask | Параллельная обработка больших данных |
| **Storage** | PostgreSQL | Хранение данных (RAW → DWH) |
| **Backend** | FastAPI | REST API и веб-интерфейс |
| **ML/AI** | Sentence-BERT | Семантический анализ логов |
| **Monitoring** | Prometheus + Grafana | Мониторинг и визуализация |
| **Infrastructure** | Docker Compose | Контейнеризация и развёртывание |

---

## 🏗️ Архитектурная схема

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ENTERPRISE LOG INTELLIGENCE PLATFORM                  │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────────┐
                              │   ИСТОЧНИКИ      │
                              │   ДАННЫХ         │
                              └────────┬─────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
    ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
    │  ZIP-архив  │            │  CSV/JSON   │            │   API       │
    │  с логами   │            │  файлы      │            │   endpoint  │
    └──────┬──────┘            └──────┬──────┘            └──────┬──────┘
           │                          │                          │
           └──────────────────────────┼──────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ETL PIPELINE (Airflow)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │     EXTRACT     │───▶│    TRANSFORM    │───▶│      LOAD       │         │
│  │                 │    │                 │    │                 │         │
│  │  • Распаковка   │    │  • Парсинг      │    │  • PostgreSQL   │         │
│  │  • Валидация    │    │  • ML-анализ    │    │  • CSV/Excel    │         │
│  │  • Сканирование │    │  • Dask ||      │    │  • API Response │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ПАРАЛЛЕЛЬНАЯ ОБРАБОТКА (Dask)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│   │   Worker 1   │  │   Worker 2   │  │   Worker 3   │  │   Worker N   │   │
│   │              │  │              │  │              │  │              │   │
│   │  Парсинг     │  │  Парсинг     │  │  Embeddings  │  │  Embeddings  │   │
│   │  файлов      │  │  файлов      │  │  генерация   │  │  генерация   │   │
│   └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                            │                  │                            │
│                            └────────┬─────────┘                            │
│                                     │                                      │
│                            ┌────────▼─────────┐                            │
│                            │  Dask Scheduler  │                            │
│                            │   :8786/:8787    │                            │
│                            └──────────────────┘                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ХРАНЕНИЕ ДАННЫХ (PostgreSQL)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         PostgreSQL :5432                            │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐         │   │
│   │  │   RAW LAYER   │   │ STAGING LAYER │   │   DWH LAYER   │         │   │
│   │  │               │──▶│               │──▶│               │         │   │
│   │  │  raw_logs     │   │ processed_logs│   │ analysis_     │         │   │
│   │  │               │   │               │   │ results       │         │   │
│   │  └───────────────┘   └───────────────┘   └───────────────┘         │   │
│   │                                                                     │   │
│   │  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐         │   │
│   │  │  incidents    │   │ predictive_   │   │ novel_        │         │   │
│   │  │               │   │ alerts        │   │ anomalies     │         │   │
│   │  └───────────────┘   └───────────────┘   └───────────────┘         │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             ML-АНАЛИЗ (PyTorch)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Sentence-BERT / Qwen3-Embedding                  │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │                                                                     │   │
│   │   1. Генерация эмбеддингов базы знаний                              │   │
│   │                     ▼                                               │   │
│   │   2. Классификация ERROR → Problem ID                               │   │
│   │                     ▼                                               │   │
│   │   3. Классификация WARNING → Anomaly ID                             │   │
│   │                     ▼                                               │   │
│   │   4. Связывание аномалий с проблемами                               │   │
│   │                     ▼                                               │   │
│   │   5. Обнаружение новых аномалий (Novel Anomalies)                   │   │
│   │                     ▼                                               │   │
│   │   6. Предсказательные алерты                                        │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ВИЗУАЛИЗАЦИЯ И МОНИТОРИНГ                           │
├────────────────────────────────┬────────────────────────────────────────────┤
│                                │                                            │
│   ┌────────────────────────┐   │   ┌────────────────────────┐              │
│   │   FastAPI Dashboard    │   │   │      Grafana           │              │
│   │        :8001           │   │   │       :3000            │              │
│   ├────────────────────────┤   │   ├────────────────────────┤              │
│   │                        │   │   │                        │              │
│   │  • KPI карточки        │   │   │  • System Load         │              │
│   │  • Timeline Chart      │   │   │  • ML Performance      │              │
│   │  • Time Machine        │   │   │  • Errors/Anomalies    │              │
│   │  • Incident Table      │   │   │  • FastAPI Metrics     │              │
│   │  • Export функции      │   │   │  • Logs Analysis       │              │
│   │                        │   │   │                        │              │
│   └────────────────────────┘   │   └────────────────────────┘              │
│                                │                                            │
│   ┌────────────────────────┐   │   ┌────────────────────────┐              │
│   │   Dask Dashboard       │   │   │     Prometheus         │              │
│   │        :8787           │   │   │       :9090            │              │
│   ├────────────────────────┤   │   ├────────────────────────┤              │
│   │  • Task Progress       │   │   │  • Metrics Storage     │              │
│   │  • Worker Status       │   │   │  • PromQL Queries      │              │
│   │  • Memory Usage        │   │   │  • Alerting Rules      │              │
│   └────────────────────────┘   │   └────────────────────────┘              │
│                                │                                            │
└────────────────────────────────┴────────────────────────────────────────────┘
```

---

## 🔧 Компоненты системы

### 1. FastAPI Application (Backend)

```
📁 api/
 ┣ 📂 v1/
 ┃ ┣ 📄 routes.py      # REST API endpoints
 ┃ ┣ 📄 models.py      # Pydantic модели
 ┃ ┣ 📄 storage.py     # Работа с хранилищем
 ┃ ┣ 📄 tasks.py       # Фоновые задачи
 ┃ ┗ 📄 middleware.py  # Middleware
 ┗ 📄 main.py          # Точка входа
```

### 2. Processing Pipeline (ML)

```
📁 processing/
 ┣ 📄 orchestrator.py      # Главный оркестратор
 ┣ 📄 log_parser.py        # Парсинг логов
 ┣ 📄 ml_analysis.py       # ML классификация
 ┣ 📄 knowledge_base.py    # База знаний
 ┣ 📄 report_generator.py  # Генерация отчетов
 ┗ 📄 playbooks.py         # Рекомендации
```

### 3. ETL Pipeline (Big Data)

```
📁 flows/
 ┗ 📄 etl_flow.py          # ETL задачи (Extract, Transform, Load)

📁 dask_jobs/
 ┗ 📄 dask_processing.py   # Параллельная обработка с Dask
```

### 4. Data Storage

```
📁 data/                   # Исходные данные
📁 storage/                # Результаты анализа
 ┣ 📄 tasks.json           # Состояние задач
 ┗ 📂 results/             # ZIP результаты
```

---

## 🔄 ETL Pipeline

### Архитектура ETL

```
┌─────────────────────────────────────────────────────────────────┐
│                         ETL PIPELINE                            │
├──────────────────┬──────────────────┬───────────────────────────┤
│     EXTRACT      │    TRANSFORM     │          LOAD             │
├──────────────────┼──────────────────┼───────────────────────────┤
│                  │                  │                           │
│ • ZIP распаковка │ • Log parsing    │ • PostgreSQL (raw_logs)   │
│ • File scanning  │ • Generalization │ • PostgreSQL (processed)  │
│ • Validation     │ • ML inference   │ • PostgreSQL (analytics)  │
│                  │ • Classification │ • CSV/Excel export        │
│                  │ • Aggregation    │ • API response            │
│                  │                  │                           │
│ Dask Delayed     │ Dask Bag         │ Batch Insert              │
│                  │ Dask DataFrame   │                           │
└──────────────────┴──────────────────┴───────────────────────────┘
```

### Поток данных

```
1. EXTRACT
   ├── Входные данные: ZIP, CSV, JSON, директории
   ├── Операции: распаковка, валидация, сканирование
   └── Выход: список файлов + метаданные

2. TRANSFORM
   ├── Входные данные: список лог-файлов
   ├── Операции (Dask):
   │   ├── Параллельный парсинг файлов
   │   ├── Генерализация сообщений
   │   ├── ML классификация (ERROR → Problem)
   │   ├── ML классификация (WARNING → Anomaly)
   │   └── Связывание и агрегация
   └── Выход: DataFrame с классифицированными логами

3. LOAD
   ├── Входные данные: обработанный DataFrame
   ├── Операции:
   │   ├── Запись в PostgreSQL (RAW → Staging → DWH)
   │   ├── Генерация отчётов (CSV, Excel)
   │   └── Обновление API
   └── Выход: путь к результатам + статистика
```

---

## 💾 Хранение данных

### Слои данных в PostgreSQL

```
┌─────────────────────────────────────────────────────────────────┐
│                    PostgreSQL Database                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    RAW LAYER                            │   │
│  │  ─────────────────────────────────────────────────────  │   │
│  │  raw_logs: сырые данные без обработки                   │   │
│  │  • timestamp, level, message, raw_log                   │   │
│  │  • file_name, line_number, source_archive               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  STAGING LAYER                          │   │
│  │  ─────────────────────────────────────────────────────  │   │
│  │  processed_logs: обработанные и классифицированные      │   │
│  │  • generalized_message                                  │   │
│  │  • problem_id, anomaly_id, match_score                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    DWH LAYER                            │   │
│  │  ─────────────────────────────────────────────────────  │   │
│  │  analysis_results: агрегированная аналитика             │   │
│  │  incidents: таблица инцидентов                          │   │
│  │  predictive_alerts: предсказания                        │   │
│  │  novel_anomalies: новые аномалии                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Таблицы базы данных

| Таблица | Описание | Слой |
|---------|----------|------|
| `raw_logs` | Сырые логи без обработки | RAW |
| `processed_logs` | Обработанные и классифицированные | Staging |
| `analysis_results` | Агрегированные результаты | DWH |
| `incidents` | Инциденты (ERROR + WARNING связи) | DWH |
| `predictive_alerts` | Предсказательные алерты | DWH |
| `novel_anomalies` | Новые аномалии | DWH |
| `etl_jobs` | История ETL задач | Metadata |

---

## 🧠 ML-анализ

### Pipeline ML-классификации

```
┌─────────────────────────────────────────────────────────────────┐
│                    ML CLASSIFICATION PIPELINE                    │
└─────────────────────────────────────────────────────────────────┘

                    ┌──────────────────────┐
                    │   Knowledge Base     │
                    │   anomalies_problems │
                    │        .csv          │
                    └──────────┬───────────┘
                               │
                               ▼
              ┌────────────────────────────────┐
              │   Генерация эмбеддингов БЗ     │
              │   • Anomaly embeddings         │
              │   • Problem embeddings         │
              └────────────────┬───────────────┘
                               │
    ┌──────────────────────────┼──────────────────────────┐
    │                          │                          │
    ▼                          ▼                          ▼
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│   ERROR     │         │   WARNING   │         │  Orphan     │
│   logs      │         │   logs      │         │  WARNINGs   │
└──────┬──────┘         └──────┬──────┘         └──────┬──────┘
       │                       │                       │
       ▼                       ▼                       ▼
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│ Match with  │         │ Context     │         │ Full KB     │
│ Problems KB │         │ matching    │         │ matching    │
│ threshold   │         │ (active     │         │ (fallback)  │
│ 0.60        │         │ problems)   │         │             │
└──────┬──────┘         └──────┬──────┘         └──────┬──────┘
       │                       │                       │
       ▼                       ▼                       ▼
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│ final_      │         │ final_      │         │ final_      │
│ problem_id  │         │ anomaly_id  │         │ anomaly_id  │
│             │         │ problem_id  │         │ problem_id  │
└─────────────┘         └─────────────┘         └─────────────┘
       │                       │                       │
       └───────────────────────┴───────────────────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   Classified Logs    │
                    │   + Impact Score     │
                    │   + Playbooks        │
                    └──────────────────────┘
```

### Модели ML

| Модель | Назначение | Размер |
|--------|------------|--------|
| all-MiniLM-L6-v2 | Лёгкая модель (быстрая) | ~80MB |
| Qwen3-Embedding-0.6B | Тяжёлая модель (точная) | ~1.2GB |

---

## 📊 Визуализация

### Компоненты визуализации

1. **FastAPI Dashboard** (:8001)
   - KPI карточки (ошибки, аномалии, проблемы)
   - Timeline Chart (динамика инцидентов)
   - Time Machine (фильтрация по времени)
   - Incident Table (детальная таблица)
   - Export (JSON, PDF, Excel)

2. **Grafana** (:3000)
   - System Load Dashboard
   - ML Performance Dashboard
   - Errors/Anomalies Dashboard
   - FastAPI Metrics
   - Logs Analysis

3. **Dask Dashboard** (:8787)
   - Task Progress
   - Worker Status
   - Memory Usage

4. **Prometheus** (:9090)
   - Metrics Storage
   - PromQL Queries

---

## 🐳 Развёртывание

### Docker Compose сервисы

```yaml
services:
  postgres:          # PostgreSQL :5432
  dask-scheduler:    # Dask Scheduler :8786/:8787
  dask-worker:       # Dask Workers (x2)
  fastapi-app:       # FastAPI :8001
  prometheus:        # Prometheus :9090
  grafana:           # Grafana :3000
```

### Порты

| Сервис | Порт | Описание |
|--------|------|----------|
| FastAPI | 8001 | REST API + Web UI |
| PostgreSQL | 5432 | База данных |
| Dask Scheduler | 8786 | Планировщик задач |
| Dask Dashboard | 8787 | Мониторинг Dask |
| Prometheus | 9090 | Сбор метрик |
| Grafana | 3000 | Визуализация метрик |

### Команды запуска

```bash
# Запуск всего стека
docker-compose up -d

# Проверка статуса
docker-compose ps

# Просмотр логов
docker-compose logs -f fastapi-app

# Остановка
docker-compose down
```

---

## 📁 Структура проекта

```
📁 Enterprise-Log-Intelligence-Platform/
 ┣ 📂 api/                    # REST API
 ┃ ┗ 📂 v1/                   # API версия 1
 ┣ 📂 data/                   # Исходные данные (ETL источники)
 ┣ 📂 dask_jobs/              # Dask обработка (Big Data)
 ┣ 📂 flows/                  # ETL Pipeline скрипты
 ┣ 📂 grafana/                # Grafana конфигурация
 ┃ ┣ 📂 dashboards/           # JSON дашборды
 ┃ ┗ 📂 provisioning/         # Автоматическая настройка
 ┣ 📂 processing/             # ML-обработка логов
 ┣ 📂 static/                 # Статические файлы
 ┣ 📂 storage/                # Результаты анализа
 ┣ 📂 templates/              # HTML шаблоны
 ┣ 📄 docker-compose.yml      # Docker конфигурация
 ┣ 📄 Dockerfile              # Образ приложения
 ┣ 📄 init-db.sql             # Инициализация PostgreSQL
 ┣ 📄 main.py                 # Точка входа FastAPI
 ┣ 📄 prometheus.yml          # Конфигурация Prometheus
 ┣ 📄 requirements.txt        # Python зависимости
 ┗ 📄 README.md               # Документация
```

---

## 📈 Метрики и мониторинг

### Prometheus метрики

- `log_analysis_total` - Общее количество анализов
- `log_analysis_duration_seconds` - Время анализа
- `zip_processed_bytes` - Размер обработанных архивов
- `anomalies_detected_total` - Обнаруженные аномалии
- `problems_classified_total` - Классифицированные проблемы
- `model_loading_duration_seconds` - Время загрузки модели
- `ml_inference_duration_seconds` - Время ML инференса
- `websocket_connections` - Активные WebSocket соединения

---

## 🔐 Безопасность

- PostgreSQL: изолированная сеть Docker
- Grafana: аутентификация admin/admin (изменить в production)
- API: базовая валидация входных данных
- CORS: настройка для разрешённых источников

---

**Версия документа:** 1.0  
**Дата:** 2025  
**Авторы:** Команда Big Data Project

